{% extends 'layouts/base_dashboard.html' %}
{% load static widget_tweaks custom_filters %}
{% block title %}New Quiz{% endblock title %}
{% block css %}{% endblock css %}
{% block head_js %}{% endblock head_js %}
{% block head %}{% endblock %}
{% block content %}

    <div class="max-w-xl mx-auto p-6">
        <h5 class="text-md font-medium capitalize text-accent-900">Create Quiz</h5>
        <hr class="my-4 border-2 border-accent-500">

        <form id="quiz-wizard-form" method="POST">
            {% csrf_token %}
            {{ wizard.management_form }}

            <!-- Quiz Step -->
            {% if wizard.steps.current == 'quiz' %}
                {% include 'quiz/quiz_forms/create_quiz_form.html' %}

                <!-- Questions and Choices Step -->
            {% elif wizard.steps.current == 'questions_and_choices' %}
                <div id="questions-container">
                    {% for question_form, choice_forms in question_forms|zip_lists:choice_forms %}
                        <div class="question-block mb-6 p-4" id="question_{{ forloop.counter }}">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-sm text-accent-500">Question {{ forloop.counter }}</h3>
                                <button type="button" class="remove-question text-primary-500 hover:text-primary-700">
                                    Remove Question
                                </button>
                            </div>
                            <!-- Render Question Form -->
                            {{ question_form.as_p }}

                            <div class="mt-4 choices-container">
                                <!-- Render Choice Forms -->
                                {% for choice_form in choice_forms %}
                                    <div class="mb-2">
                                        {#                                        {{ choice_form.as_p }}#}
                                        <label class="block py-2.5 px-0 w-full text-sm text-accent-900 bg-transparent border-0 border-b-2 border-accent-300 appearance-none focus:outline-none focus:ring-0 focus:border-accent-600 peer">
                                            {{ choice_form.is_correct }} Correct
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>

                <!-- Add Question Button -->
                <button type="button" id="add-question"
                        class="text-accent-500 bg-light-500 hover:bg-light-700 focus:ring-4 focus:outline-none focus:ring-light-300 font-medium rounded-xl text-sm px-5 py-3 text-center">
                    Add Question
                </button>
            {% endif %}

            <!-- Navigation Buttons -->
            <div class="mt-6 flex justify-between">
                {% if wizard.steps.prev %}
                    <button name="wizard_goto_step" type="submit" value="{{ wizard.steps.prev }}"
                            class="text-light-50 bg-accent-500 hover:bg-accent-700 focus:ring-4 focus:outline-none focus:ring-accent-300 font-medium rounded-xl text-sm px-5 py-3 text-center">
                        Previous step
                    </button>
                {% endif %}
                <input type="submit" value="{% if wizard.steps.last %}Submit{% else %}Next step{% endif %}"
                       class="text-light-50 bg-primary-500 hover:bg-primary-700 focus:ring-4 focus:outline-none focus:ring-primary-300 font-medium rounded-xl text-sm px-5 py-3 text-center">
            </div>
        </form>
    </div>

    <!-- JavaScript to Handle Adding and Removing Questions Dynamically -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const addQuestionButton = document.getElementById('add-question');
            const questionsContainer = document.getElementById('questions-container');
            let questionCounter = {{ question_forms|length }};
            
            function addQuestion() {
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question-block mb-6 p-4';
                questionDiv.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-sm text-accent-500">Question ${questionCounter + 1}</h3>
                    <button type="button" class="remove-question text-primary-500 hover:text-primary-700">
                        Remove Question
                    </button>
                </div>
                <input type="text" name="question_${questionCounter}_text" class="block py-2.5 px-0 w-full text-sm text-accent-900 bg-transparent border-0 border-b-2 border-accent-300 appearance-none focus:outline-none focus:ring-0 focus:border-accent-600 peer" placeholder="Enter question text" required>
                <div class="mt-8 choices-container">
                    ${[1, 2, 3, 4].map(i => `
                        <div class="mb-2">
                            <input type="text" name="question_${questionCounter}_choice_${i}_text" class="w-3/4 block py-2.5 px-0 w-full text-sm text-accent-900 bg-transparent border-0 border-b-2 border-accent-300 appearance-none focus:outline-none focus:ring-0 focus:border-accent-600 peer" placeholder="Choice ${i}" required>
                            <input type="checkbox" name="question_${questionCounter}_choice_${i}_is_correct" class="ml-2 rounded-full"> Correct
                        </div>
                    `).join('')}
                </div>
            `;
                questionsContainer.appendChild(questionDiv);
                questionCounter++;
            }
            
            function removeQuestion(event) {
                if (event.target.classList.contains('remove-question')) {
                    const questionBlock = event.target.closest('.question-block');
                    questionBlock.remove();
                    questionCounter--;
                    updateQuestionNumbers();
                }
            }
            
            function updateQuestionNumbers() {
                const questionBlocks = questionsContainer.querySelectorAll('.question-block');
                questionBlocks.forEach((block, index) => {
                    const heading = block.querySelector('h3');
                    heading.textContent = `Question ${index + 1}`;
                });
            }
            
            if (addQuestionButton) {
                addQuestionButton.addEventListener('click', addQuestion);
            }
            
            questionsContainer.addEventListener('click', removeQuestion);
        });
    </script>

{% endblock content %}
{% block footer_js %}{% endblock footer_js %}